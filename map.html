<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>회사 영업망 지도</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; }
    header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; gap: 12px; align-items: center; }
    header h1 { font-size: 18px; margin: 0; font-weight: 600; }
    #main { display: grid; grid-template-columns: 320px 1fr; height: calc(100% - 58px); }
    #sidebar { border-right: 1px solid #eee; padding: 12px; overflow: auto; }
    #map { height: 100%; }
    .legend { background: #fff; padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.12); font-size: 12px; }
    .legend h3 { margin: 0 0 6px; font-size: 12px; font-weight: 700; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.1); background: #fafafa; }
    input, select, button, textarea { font: inherit; }
    input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea, select { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    button { padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    button:hover { background: #f7f7f7; }
    details { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; }
    summary { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .mb8 { margin-bottom: 8px; }
    .mb12 { margin-bottom: 12px; }
    .muted { color: #666; font-size: 12px; }
    .stat { display:flex; justify-content: space-between; margin: 4px 0; font-size: 13px; }
    .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #e5e7eb; border-radius:999px; padding:2px 8px; background:#fff; }
  </style>
  <!--
    ⭐ 기능 요약
    - 데이터 소스 2가지: (A) 공개 CSV/gviz URL, (B) Google Sheets API(v4) 직접 연동(시트ID+범위+API 키)
    - 시트 헤더: name,lat,lng,radius_km,count,color,stroke_color,stroke_opacity,fill_opacity,note
    - count(도입 구좌수) 기반 색 구간(경계값)과 팔레트 즉시 조정, 범례 자동 갱신
    - 필터: 이름 검색, count 최소/최대, count 없음 숨기기
    - 집계: 총 지점 수, count 합계, 구간별 개수
    - (선택) GeoJSON URL로 권역 폴리곤 오버레이 (속성: name, region_count 등)
  -->
</head>
<body>
  <header>
    <h1>영업망 지도</h1>
    <span class="pill" id="countPill">데이터: 0개</span>
    <span class="pill" id="verPill">버전 표시 준비중…</span>
  </header>

  <!-- 디버그 배너 -->
  <div id="debugBanner" style="display:none;padding:8px 12px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;font-size:13px">
    지도 초기화에 실패했습니다. 아래 점검을 따라주세요. <button id="dbgToggle" style="margin-left:8px">상세 보기</button>
  </div>
  <div id="debugPanel" style="display:none;padding:10px 12px;border-bottom:1px solid #eee;font-size:12px;line-height:1.5">
    <div><b>현재 Origin:</b> <span id="dbgOrigin"></span></div>
    <div><b>오류 로그:</b></div>
    <pre id="dbgLog" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;max-height:160px;overflow:auto"></pre>
    <div><b>체크리스트</b></div>
    <ul style="margin:6px 0 0 18px">
      <li>키 오타 여부 (공백/따옴표 포함 X)</li>
      <li>Maps JavaScript API <u>사용 설정</u> 여부</li>
      <li>결제 계정 연결 여부 (월 $200 무료 크레딧)</li>
      <li>HTTP referrer 제한에 <code id="dbgRef"></code> 또는 <code id="dbgRef2"></code> 추가</li>
      <li>광고/추적 차단 확장프로그램 일시 비활성화</li>
      <li>HTTPS로 접속, 혼합콘텐츠 차단 여부 확인</li>
    </ul>
  </div>

  <div id="main">
    <aside id="sidebar">
      <details open class="mb12">
        <summary>데이터 소스</summary>
        <div class="mb8">
          <label class="mb8">모드</label>
          <select id="mode">
            <option value="url">A) 공개 CSV / gviz JSON URL</option>
            <option value="sheets">B) Google Sheets API (시트ID + 범위 + API Key)</option>
          </select>
        </div>
        <div id="mode-url" class="mb12">
          <label class="mb8">시트 공개 URL</label>
          <input id="sheetUrl" type="url" placeholder="예: https://docs.google.com/spreadsheets/d/…/pub?output=csv 또는 …/gviz/tq?…" />
        </div>
        <div id="mode-sheets" class="mb12" style="display:none">
          <div class="mb8"><label>시트 ID</label><input id="sheetId" type="text" placeholder="문서 URL의 /d/와 /edit 사이 ID" /></div>
          <div class="mb8"><label>범위</label><input id="sheetRange" type="text" placeholder="예: Sheet1!A1:J999" /></div>
          <div class="mb8"><label>Google API Key</label><input id="sheetsApiKey" type="password" placeholder="브라우저 노출 주의: 도메인 제한 권장" /></div>
          <div class="muted">※ 시트가 비공개면 클라이언트에서 접근 불가합니다. 필요 시 백엔드 프록시/Apps Script 사용 권장.</div>
        </div>
        <div class="mb8"><label>GeoJSON URL(선택)</label><input id="geojsonUrl" type="url" placeholder="권역 폴리곤 GeoJSON 주소 (옵션)" /></div>
        <div class="row mb8">
          <div><label>자동 새로고침(초)</label><input id="refreshSec" type="number" min="0" value="0" /></div>
          <div><label>&nbsp;</label><div style="display:flex;gap:6px"><button id="loadBtn">불러오기</button><button id="demoBtn" type="button">데모 불러오기</button></div></div>
        </div>
      </details>

      <details open class="mb12">
        <summary>강도(도입 구좌수) 색상</summary>
        <div class="row mb8">
          <div>
            <label>경계값(쉼표)</label>
            <input id="thresholds" type="text" value="100,500,1000,2000" />
          </div>
          <div>
            <label>팔레트</label>
            <select id="palette">
              <option value="spectral">Spectral</option>
              <option value="viridis">Viridis</option>
              <option value="blues">Blues</option>
              <option value="reds">Reds</option>
            </select>
          </div>
        </div>
        <label class="mb8" style="display:block"><input id="enableDensity" type="checkbox" checked /> 강도 색칠 사용(count)</label>
        <div id="legendBox" class="mb8"></div>
      </details>

      <details open class="mb12">
        <summary>필터</summary>
        <div class="mb8"><label>이름 포함</label><input id="fName" type="text" placeholder="예: 서울, 부산" /></div>
        <div class="row mb8">
          <div><label>count ≥</label><input id="fMin" type="number" placeholder="최소" /></div>
          <div><label>count ≤</label><input id="fMax" type="number" placeholder="최대" /></div>
        </div>
        <label class="mb8" style="display:block"><input id="fHideNaN" type="checkbox" /> count 없는 행 숨기기</label>
        <button id="applyFilter">필터 적용</button>
      </details>

      <details open>
        <summary>집계</summary>
        <div id="stats"></div>
      </details>
    </aside>

    <div id="map" role="region" aria-label="영업망 지도"></div>
  </div>

  <script>
    // DOMContentLoaded 시에도 버전을 표시(지도 초기화 실패 시 '준비중…' 방지)
    document.addEventListener('DOMContentLoaded', () => {
      const vp = document.getElementById('verPill');
      if (vp) vp.textContent = `버전 v1.3.0 · 2025-09-07`;
    });

    // ===== 기본 설정 =====
    const DEFAULT_CENTER = { lat: 36.5, lng: 127.8 };
    const DEFAULT_ZOOM = 7;
    const APP_VERSION = 'v1.3.0';
    const BUILD_DATE = '2025-09-07';

    // ===== 유틸 =====
    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function coerceNumber(v){ if(v==null) return NaN; if(typeof v==='number') return v; const n=parseFloat(String(v).replace(/,/g,'')); return isNaN(n)?NaN:n; }
    function pickColor(i){ const p=['#2563eb','#16a34a','#f59e0b','#ef4444','#8b5cf6','#0ea5e9','#22c55e','#d946ef']; return p[i%p.length]; }

    // CSV 파서(따옴표 처리)
    function parseCSV(text) {
      const rows = [];
      let i = 0, cur = '', row = [], inQuotes = false;
      while (i < text.length) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            if (text[i + 1] === '"') { cur += '"'; i++; }
            else { inQuotes = false; }
          } else { cur += ch; }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { row.push(cur); cur = ''; }
          else if (ch === '
' || ch === '
') {
            if (cur !== '' || row.length) { row.push(cur); rows.push(row); row = []; cur = ''; }
          } else { cur += ch; }
        }
        i++;
      }
      if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
      if (!rows.length) throw new Error('CSV 내용이 비어있습니다.');
      const header = rows.shift().map(h => h.trim());
      return { cols: header, rows };
    }

    // gviz 파서 → 표 형태
    function parseGviz(raw){ const s=raw.indexOf('('), e=raw.lastIndexOf(')'); if(s===-1||e===-1) throw new Error('gviz 응답 형식 오류'); const obj=JSON.parse(raw.slice(s+1,e)); const cols=obj.table.cols.map(c=>c.label||c.id||''); const rows=obj.table.rows.map(r=>r.c.map(c=>c?c.v:'')); return { cols, rows }; }

    function getThresholds(){ return (document.getElementById('thresholds').value||'').split(',').map(s=>parseFloat(s.trim())).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b); }
    function getBin(v,ths){ for(let i=0;i<ths.length;i++){ if(v<ths[i]) return i; } return ths.length; }
    function getPalette(n){ const maps={ spectral:['#9e0142','#d53e4f','#f46d43','#fdae61','#fee08b','#e6f598','#abdda4','#66c2a5','#3288bd','#5e4fa2'], viridis:['#440154','#482475','#414487','#355f8d','#2a788e','#21918c','#22a884','#44bf70','#7ad151','#fde725'], blues:['#eff3ff','#c6dbef','#9ecae1','#6baed6','#3182bd','#08519c'], reds:['#fee5d9','#fcbba1','#fc9272','#fb6a4a','#de2d26','#a50f15'] }; const key=document.getElementById('palette').value||'spectral'; const base=maps[key]; if(n<=base.length) return base.slice(0,n); const out=[]; for(let i=0;i<n;i++){ const idx=Math.round(i*(base.length-1)/(n-1)); out.push(base[idx]); } return out; }

    // ===== 상태 =====
    let map, infoWindow, circles=[], lastItems=[], polygons=[]; let refreshTimer=null;

    function initMap(){
      // 버전 표시
      const vp = document.getElementById('verPill');
      if (vp) vp.textContent = `버전 ${APP_VERSION} · ${BUILD_DATE}`;

      map=new google.maps.Map(document.getElementById('map'),{ center:DEFAULT_CENTER, zoom:DEFAULT_ZOOM, mapTypeControl:false });
      infoWindow=new google.maps.InfoWindow();
      document.getElementById('mode').addEventListener('change', onModeChange);
      document.getElementById('loadBtn').addEventListener('click', ()=>{ loadAll(); setupAutoRefresh(); });
      document.getElementById('demoBtn').addEventListener('click', loadDemoData);
      document.getElementById('applyFilter').addEventListener('click', ()=> renderCircles(filterItems(lastItems)) );
      ['thresholds','palette','enableDensity'].forEach(id=> document.getElementById(id).addEventListener('change', ()=> renderCircles(filterItems(lastItems)) ));
    });
      infoWindow=new google.maps.InfoWindow();
      document.getElementById('mode').addEventListener('change', onModeChange);
      document.getElementById('loadBtn').addEventListener('click', ()=>{ loadAll(); setupAutoRefresh(); });
      document.getElementById('applyFilter').addEventListener('click', ()=> renderCircles(filterItems(lastItems)) );
      ['thresholds','palette','enableDensity'].forEach(id=> document.getElementById(id).addEventListener('change', ()=> renderCircles(filterItems(lastItems)) ));
    }

    function onModeChange(){ const m=document.getElementById('mode').value; document.getElementById('mode-url').style.display = (m==='url')?'block':'none'; document.getElementById('mode-sheets').style.display = (m==='sheets')?'block':'none'; }

    function setupAutoRefresh(){ const sec=parseInt(document.getElementById('refreshSec').value||'0',10); if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; } if(sec>0){ refreshTimer=setInterval(loadAll, sec*1000); } }

    async function loadAll(){ try{ const items = await loadPointItems(); lastItems = items; const geoUrl=document.getElementById('geojsonUrl').value.trim(); if(geoUrl){ await loadPolygons(geoUrl); } renderCircles(filterItems(items)); } catch(e){ console.error(e); alert('데이터 불러오기 실패: '+(e?.message||e)); }}

    function loadDemoData(){
      const csv = `name,lat,lng,radius_km,count,color,stroke_color,stroke_opacity,fill_opacity,note
`
                + `서울본부,37.5665,126.9780,30,1450,,,,,수도권 총괄
`
                + `부산지사,35.1796,129.0756,20,320,,,,,영남권 관리
`
                + `대전센터,36.3504,127.3845,15,150,,,,,중부권 지원`;
      const table = parseCSV(csv);
      const idx={}; const names=table.cols.map(c=>String(c).trim().toLowerCase());
      ['name','lat','lng','radius_km','count','color','stroke_color','stroke_opacity','fill_opacity','note'].forEach(k=> idx[k]=names.indexOf(k));
      const items = table.rows.map((r,i)=>{
        const name = idx.name>=0 ? r[idx.name] : `지점 ${i+1}`;
        const lat = coerceNumber(r[idx.lat]);
        const lng = coerceNumber(r[idx.lng]);
        const radius_km = coerceNumber(r[idx.radius_km]);
        const count = idx.count>=0 ? coerceNumber(r[idx.count]) : NaN;
        const color = (idx.color>=0 && r[idx.color]) ? r[idx.color] : pickColor(i);
        const strokeColor = (idx.stroke_color>=0 && r[idx.stroke_color]) ? r[idx.stroke_color] : color;
        const strokeOpacity = (idx.stroke_opacity>=0 && r[idx.stroke_opacity]) ? Number(r[idx.stroke_opacity]) : 0.9;
        const fillOpacity = (idx.fill_opacity>=0 && r[idx.fill_opacity]) ? Number(r[idx.fill_opacity]) : 0.18;
        const note = (idx.note>=0 && r[idx.note]) ? r[idx.note] : '';
        return { name, lat, lng, radius_km, count, color, strokeColor, strokeOpacity, fillOpacity, note };
      }).filter(it=> Number.isFinite(it.lat) && Number.isFinite(it.lng) && Number.isFinite(it.radius_km));
      lastItems = items;
      renderCircles(filterItems(items));
    } renderCircles(filterItems(items)); } catch(e){ console.error(e); alert('데이터 불러오기 실패: '+(e?.message||e)); } }

    async function loadPointItems(){ const mode=document.getElementById('mode').value; let table; if(mode==='url'){ const url=document.getElementById('sheetUrl').value.trim(); if(!url) throw new Error('시트 공개 URL을 입력하세요'); const text=await (await fetch(url)).text(); table = url.includes('/gviz/tq') ? parseGviz(text) : parseCSV(text); }
      else { const id=document.getElementById('sheetId').value.trim(); const range=encodeURIComponent(document.getElementById('sheetRange').value.trim()); const key=document.getElementById('sheetsApiKey').value.trim(); if(!id||!range||!key) throw new Error('시트ID, 범위, API Key를 입력하세요'); const url=`https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${range}?key=${key}`; const json=await (await fetch(url)).json(); if(!json.values||!json.values.length) throw new Error('시트에 데이터가 없습니다'); const cols=json.values[0]; const rows=json.values.slice(1); table={ cols, rows }; }

      // 컬럼 매핑
      const idx={}; const names=table.cols.map(c=>String(c).trim().toLowerCase()); ['name','lat','lng','radius_km','count','color','stroke_color','stroke_opacity','fill_opacity','note'].forEach(k=> idx[k]=names.indexOf(k));
      const items = table.rows.map((r,i)=>{
        const name = idx.name>=0 ? r[idx.name] : `지점 ${i+1}`;
        const lat = coerceNumber(r[idx.lat]);
        const lng = coerceNumber(r[idx.lng]);
        const radius_km = coerceNumber(r[idx.radius_km]);
        const count = idx.count>=0 ? coerceNumber(r[idx.count]) : NaN;
        const color = (idx.color>=0 && r[idx.color]) ? r[idx.color] : pickColor(i);
        const strokeColor = (idx.stroke_color>=0 && r[idx.stroke_color]) ? r[idx.stroke_color] : color;
        const strokeOpacity = (idx.stroke_opacity>=0 && r[idx.stroke_opacity]) ? Number(r[idx.stroke_opacity]) : 0.9;
        const fillOpacity = (idx.fill_opacity>=0 && r[idx.fill_opacity]) ? Number(r[idx.fill_opacity]) : 0.18;
        const note = (idx.note>=0 && r[idx.note]) ? r[idx.note] : '';
        return { name, lat, lng, radius_km, count, color, strokeColor, strokeOpacity, fillOpacity, note };
      }).filter(it=> Number.isFinite(it.lat) && Number.isFinite(it.lng) && Number.isFinite(it.radius_km));

      return items;
    }

    function filterItems(items){ if(!items||!items.length) return []; const q=(document.getElementById('fName').value||'').trim(); const min=parseFloat(document.getElementById('fMin').value); const max=parseFloat(document.getElementById('fMax').value); const hideNaN=document.getElementById('fHideNaN').checked; return items.filter(it=>{
        if(q && !it.name.includes(q)) return false;
        if(Number.isFinite(min) && !(Number.isFinite(it.count) && it.count>=min)) return false;
        if(Number.isFinite(max) && !(Number.isFinite(it.count) && it.count<=max)) return false;
        if(hideNaN && !Number.isFinite(it.count)) return false;
        return true; });
    }

    async function loadPolygons(url){ try{
      const res=await fetch(url); const gj=await res.json();
      // 기존 폴리곤 제거
      polygons.forEach(p=>p.setMap(null)); polygons=[];
      // 스타일: region_count -> 색칠(있으면), 없으면 기본
      const ths=getThresholds(); const pal=getPalette(ths.length+1); const densityOn=document.getElementById('enableDensity').checked;
      gj.features?.forEach((f,i)=>{
        const geom=f.geometry; if(!geom) return;
        const props=f.properties||{}; const val=coerceNumber(props.region_count);
        const fill = (densityOn && Number.isFinite(val)) ? pal[getBin(val,ths)] : '#000000';
        const poly = new google.maps.Data(); poly.addGeoJson({ type:'FeatureCollection', features:[f] });
        poly.setStyle({ fillColor: fill, fillOpacity: 0.08, strokeColor: fill, strokeOpacity: 0.7, strokeWeight: 1 });
        poly.setMap(map);
        poly.addListener('click', (e)=>{
          const center = e.feature.getProperty('center') || e.latLng || map.getCenter();
          const html = `<div style="min-width:240px">
            <div style="font-weight:700;margin-bottom:4px">${escapeHtml(props.name||`폴리곤 ${i+1}`)}</div>
            ${Number.isFinite(val)?`<div>region_count: ${val}</div>`:''}
          </div>`; infoWindow.setContent(html); infoWindow.setPosition(center); infoWindow.open({map});
        });
        polygons.push(poly);
      });
    }catch(e){ console.warn('GeoJSON 로드 실패:', e.message); }
    }

    function renderCircles(items){
      // 원 제거
      circles.forEach(c=>c.setMap(null)); circles=[];
      const bounds=new google.maps.LatLngBounds();
      const ths=getThresholds(); const pal=getPalette(ths.length+1); const densityOn=document.getElementById('enableDensity').checked;

      items.forEach((it)=>{
        const center={lat:it.lat,lng:it.lng};
        const fillColor=(densityOn && Number.isFinite(it.count))? pal[getBin(it.count,ths)] : it.color;
        const strokeColor=(densityOn && Number.isFinite(it.count))? fillColor : it.strokeColor;
        const circle=new google.maps.Circle({ map, center, radius: it.radius_km*1000, strokeColor, strokeOpacity: it.strokeOpacity, strokeWeight: 2, fillColor, fillOpacity: it.fillOpacity });
        circles.push(circle); bounds.extend(center);
        circle.addListener('click',()=>{
          const html=`<div style="min-width:240px">
            <div style="font-weight:700;margin-bottom:4px">${escapeHtml(it.name)}</div>
            <div>위치: ${it.lat.toFixed(4)}, ${it.lng.toFixed(4)}</div>
            <div>반경: ${it.radius_km} km</div>
            ${Number.isFinite(it.count)?`<div>도입 구좌수(count): ${it.count}</div>`:''}
            ${it.note?`<div style=\"margin-top:6px\">${escapeHtml(it.note)}</div>`:''}
          </div>`; infoWindow.setContent(html); infoWindow.setPosition(center); infoWindow.open({map}); });
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds);
      document.getElementById('countPill').textContent=`데이터: ${items.length}개`;
      renderLegend(ths,pal); renderStats(items, ths);
    }

    function renderLegend(ths,pal){
      const el=document.getElementById('legendBox');
      const blocks=[]; if(ths.length===0){ blocks.push({label:'모든 값', color: pal[0]}); } else { for(let i=0;i<=ths.length;i++){ let label=''; if(i===0) label=`< ${ths[0]}`; else if(i===ths.length) label=`≥ ${ths[i-1]}`; else label=`${ths[i-1]}–${ths[i]-1}`; blocks.push({label, color: pal[i]}); } }
      el.innerHTML = '<div class="legend"><h3>강도 스케일</h3>' + blocks.map(b=>`<div style="display:flex;align-items:center;gap:8px;margin:4px 0"><span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${b.color};border:1px solid rgba(0,0,0,.2)"></span><span>${b.label}</span></div>`).join('') + '</div>';
    }

    function renderStats(items, ths){
      const el=document.getElementById('stats'); const total=items.length; const sum=items.reduce((a,b)=> a + (Number.isFinite(b.count)? b.count:0), 0);
      const bins=new Array(ths.length+1).fill(0);
      items.forEach(it=>{ if(Number.isFinite(it.count)) bins[getBin(it.count,ths)]++; });
      let html=''; html += `<div class="stat"><span>총 지점 수</span><b>${total.toLocaleString()}</b></div>`;
      html += `<div class="stat"><span>count 합계</span><b>${sum.toLocaleString()}</b></div>`;
      for(let i=0;i<bins.length;i++){
        let label=''; if(i===0) label=`< ${ths[0]??'∞'}`; else if(i===bins.length-1) label=`≥ ${ths[ths.length-1]??'0'}`; else label=`${ths[i-1]}–${ths[i]-1}`; html += `<div class="stat"><span>${label}</span><b>${bins[i].toLocaleString()}</b></div>`;
      }
      el.innerHTML=html;
    }
  </script>

  <!-- 디버그 스크립트: initMap 호출 감시 & 오류 표시 -->
  <script>
    (function(){
      const banner = document.getElementById('debugBanner');
      const panel = document.getElementById('debugPanel');
      const logEl = document.getElementById('dbgLog');
      const originEl = document.getElementById('dbgOrigin');
      const refEl = document.getElementById('dbgRef');
      const ref2El = document.getElementById('dbgRef2');
      originEl.textContent = location.origin;
      refEl.textContent = location.origin.replace(/\/$/, '') + '/*';
      ref2El.textContent = location.protocol + '//' + location.host + '/*';
      let inited = false;
      const oldInit = window.initMap;
      window.initMap = function(){ inited = true; oldInit && oldInit(); };
      // 6초 내 initMap 미호출 시 배너 노출
      setTimeout(()=>{ if(!inited){ banner.style.display='block'; } else {
        // initMap은 호출됐지만 타일이 안 보이는 경우 대비: 일정 시간 동안 지도 중심/줌 변화가 없으면 로그 남김
        setTimeout(()=>{
          try {
            const c = map && map.getCenter && map.getCenter();
            if (!c) throw new Error('지도 객체가 초기화되지 않았습니다. (getCenter null)');
          } catch (e) {
            const logEl = document.getElementById('dbgLog');
            if (logEl) logEl.textContent += '[Debug] initMap은 호출되었으나 지도 상태 점검 필요: '+ (e.message||e) +'
';
            const banner = document.getElementById('debugBanner');
            if (banner) banner.style.display='block';
          }
        }, 2000);
      } }, 6000);
      document.getElementById('dbgToggle').addEventListener('click',()=>{
        panel.style.display = panel.style.display==='none'?'block':'none';
      });
      const log = (m)=>{ logEl.textContent += (m+'
'); };
      window.addEventListener('error', e=>{ log('[Error] '+(e.message||e.filename||e.type)); banner.style.display='block'; });
      window.addEventListener('unhandledrejection', e=>{ log('[PromiseRejection] '+(e.reason && (e.reason.message||e.reason)) ); banner.style.display='block'; });
    })();
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJKF6l-C4shNQbO99oImE6D_69JL7ZnnE&callback=initMap"></script>
</body>
</html>
